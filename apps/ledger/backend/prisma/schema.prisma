generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CreditEventType {
  EARN
  SPEND
  ADJUST
}

enum CreditEventStatus {
  VALID
  VOID
  PENDING
}

model CreditEvent {
  id           String            @id @default(uuid()) @db.Uuid
  event_uid    String            @unique // 核心幂等键
  source       String
  user_id      String
  type         CreditEventType
  amount       BigInt            // 使用 BigInt 避免精度问题
  currency     String            @default("CREDIT")
  title        String?
  meta         Json?
  status       CreditEventStatus @default(VALID)
  occurred_at  DateTime
  ingested_at  DateTime          @default(now())

  @@index([user_id, occurred_at(sort: Desc)])
  @@index([user_id, ingested_at(sort: Desc)])
  @@map("credit_events")
}

model CreditBalance {
  id           String   @id @default(uuid()) @db.Uuid
  user_id      String
  currency     String
  balance      BigInt   @default(0)
  earned_total BigInt   @default(0)
  spent_total  BigInt   @default(0)
  updated_at   DateTime @updatedAt

  @@unique([user_id, currency])
  @@map("credit_balances")
}

// v0.6 新增: 用户鉴权控制
model UserAuth {
  user_id              String    @id
  token_revoked_before DateTime?
  updated_at           DateTime  @updatedAt

  @@map("user_auth")
}
