version: '3.8'

services:
  db:
    image: postgres:15
    container_name: credits_db_prod
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
    # Production DB usually not exposed, or only to localhost if needed for debugging
    ports:
      - "127.0.0.1:5432:5432"

  backend:
    build:
      context: ../../
      dockerfile: backend/Dockerfile
      target: runner
    image: credits-ledger/backend:latest
    container_name: credits_backend_prod
    environment:
      NODE_ENV: production
      PORT: 4000
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_TOKEN: ${ADMIN_TOKEN}
      CORS_ORIGIN: ${CORS_ORIGIN}
      WRITE_ENABLED_USERS: ${WRITE_ENABLED_USERS:-smoke-tester-prod}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}?schema=public
    # Expose only to localhost (Nginx should proxy to this)
    ports:
      - "127.0.0.1:4000:4000"
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:4000/healthz', (r) => {if (r.statusCode !== 200) process.exit(1); process.exit(0)}).on('error', () => process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  migrate:
    build:
      context: ../../
      dockerfile: backend/Dockerfile
      target: builder
    image: credits-ledger/migrate:latest
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}?schema=public
    working_dir: /app/backend
    # Production only runs deploy, never dev
    command: npx prisma migrate deploy
    depends_on:
      db:
        condition: service_healthy
    profiles: ["tools"]

  smoke:
    build:
      context: ../../
      dockerfile: backend/Dockerfile
      target: builder
    image: credits-ledger/migrate:latest
    environment:
      # Need JWT_SECRET to generate token
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_TOKEN: ${ADMIN_TOKEN}
      SMOKE_USER: smoke-tester-prod
    working_dir: /app/backend
    entrypoint: ["/bin/bash", "-c"]
    command: 
      - |
        echo "ðŸ”‘ Generating Token..."
        eval $$(npx ts-node scripts/generate-token.ts)
        echo "ðŸš€ Running Smoke Test..."
        export SMOKE_BASE_URL=$${SMOKE_BASE_URL:-http://backend:4000}
        npx ts-node scripts/smoke.ts
    depends_on:
      backend:
        condition: service_healthy
    profiles: ["tools"]

volumes:
  postgres_data_prod:
